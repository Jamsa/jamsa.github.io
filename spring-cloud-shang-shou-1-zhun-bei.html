<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="author" content="Jamsa" />
        <meta name="robots" content="index, follow"/>

        <meta property="og:title" content="Spring Cloud 上手1-准备"/>
        <meta property="og:url" content="./spring-cloud-shang-shou-1-zhun-bei.html"/>
        <meta property="og:site_name" content="Jamsa的笔记"/>
        <meta property="og:type" content="article"/>

        <link rel="canonical" href="./spring-cloud-shang-shou-1-zhun-bei.html" />

        <title>Spring Cloud 上手1-准备 | Jamsa的笔记</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />
        

        <link rel="stylesheet" type="text/css" href="./theme/css/main.css" />

        <script type="text/javascript">var switchTo5x=true;</script>
        <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
        <script type="text/javascript">
         stLight.options({
             publisher: "",
             doNotHash: false,
             doNotCopy: false,
             hashAddressBar: false
         });
        </script>
    </head>

    <body id="index">
        <div class="row-fluid">
            <div class="span10 offset1">
                <header id="banner" >
                    <h1>
                        <a href="./">Jamsa的笔记 </a>
                    </h1>
                    <nav class="navbar">
                        <div class="navbar-inner">
                            <ul class="nav">
                                <li ><a href="./category/da-shu-ju.html">大数据</a></li>
                                <li ><a href="./category/fang-fa.html">方法</a></li>
                                <li ><a href="./category/ji-qi-xue-xi.html">机器学习</a></li>
                                <li class="active"><a href="./category/kai-fa.html">开发</a></li>
                                <li ><a href="./category/qian-duan.html">前端</a></li>
                                <li ><a href="./category/xiao-lu.html">效率</a></li>
                                <li ><a href="./category/yi-dong.html">移动</a></li>
                            </ul>

                        </div>
                    </nav>
                </header><!-- /#banner -->
            </div>
        </div>

        <div class="row-fluid">
            <div class="span10 offset1">
                <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./spring-cloud-shang-shou-1-zhun-bei.html" rel="bookmark"
             title="Permalink to Spring Cloud 上手1-准备">Spring Cloud 上手1-准备</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="./author/jamsa.html">Jamsa</a>
    </address>

    in <a href="./category/kai-fa.html">开发</a>

    on 2018-05-30

        |
        tags:         <a href="./tag/spring-cloud.html">spring cloud</a>


        |
        <a href="./spring-cloud-shang-shou-1-zhun-bei.html#disqus_thread">comments</a>

    
</footer><!-- /.post-info -->

        <h1>目标</h1>
<p>从15年开始我一直在使用Dubbo框架进行开发，少量在使用Spring Boot开发一些独立的App服务程序。Spring Cloud相关的文档资料看了不少，但&ldquo;纸上得来终觉浅，绝知此事要躬行&rdquo;。所以就有了做一个Spring Cloud Demo工程的想法，主要用来体验Spring Cloud的各种组件和功能。</p>
<p>代码放在<a href="https://github.com/Jamsa/sc-cloud">GitHub</a>上，随着本系列文章更新。</p>
<h1>规划</h1>
<p>先从最简单的Demo开始，使用SpringCloud的基础功能：Eureka、Zuul、Feign。后续再考虑添加Stream，Bus相关的内容。在工程数量较多，不好维护了，再考虑采用docker和minikube来进行管理。借用一句话&ldquo;好的架构就像眼镜，你会知道什么时候需要它&rdquo;。</p>
<p>工程目录规划如下：</p>
<div class="highlight"><pre><span></span>├── build.gradle
├── common
│&nbsp;&nbsp; ├── build.gradle
│&nbsp;&nbsp; └── src
│&nbsp;&nbsp;     └── main
├── provider
│&nbsp;&nbsp; ├── api
│&nbsp;&nbsp; │&nbsp;&nbsp; └── src
│&nbsp;&nbsp; └── service
│&nbsp;&nbsp;     ├── build.gradle
│&nbsp;&nbsp;     └── src
├── consumer
│&nbsp;&nbsp; ├── api
│&nbsp;&nbsp; │&nbsp;&nbsp; └── src
│&nbsp;&nbsp; └── service
│&nbsp;&nbsp;     ├── build.gradle
│&nbsp;&nbsp;     └── src
├── gateway
│&nbsp;&nbsp; ├── build.gradle
│&nbsp;&nbsp; └── src
├── registry
│&nbsp;&nbsp; ├── build.gradle
│&nbsp;&nbsp; └── src
├── settings.gradle
├── support
└── web
</pre></div>
<ul>
<li>
<p><code>provider</code>和<code>consumer</code>为两个业务服务模块，其中<code>provider</code>和<code>consumer</code>只做目录分类用，不是实际的模块。<code>api</code>和<code>service</code>是模块，<code>api</code>存放客户端服务端共享的接口和类，<code>service</code>是实际的服务提供者。</p>
</li>
<li>
<p><code>registry</code>为Eureka为基础构建的服务注册中心。</p>
</li>
<li>
<p><code>gateway</code>为Zuul为基础构建的服务网关，是外部访问的入口。</p>
</li>
<li>
<p><code>common</code>存放公共类，非SpringBoot模块。</p>
</li>
<li>
<p><code>support</code>存放支持程序运行的<code>docker-compose</code>配置信息和<code>docker</code>容器数据卷。</p>
</li>
</ul>
<p>在构建工具的选择上，Github上各路大神的SpringCloud Demo基本上都是以Maven为主的。我这里选择gradle了，只是为了减少编写配置信息。</p>
<h1>Gradle配置规划</h1>
<p>使用Gradle进行多模块配置，可选的配置方案有两种，一种是把配置信息集中在根模块的构建文件中集中配置，另一种是各模块独立配置。这里我考虑结合使用这两种配置方式，将全局配置和版式化的配置集中在根模块的build.gradle进行管理，各个子模块的只在自己的build.gradle中维护其依赖声明等个性化的信息。</p>
<h2>根模块的settings.gradle</h2>
<div class="highlight"><pre><span></span><span class="n">rootProject</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="s1">'sc-cloud'</span>

<span class="n">include</span> <span class="s1">'registry'</span><span class="o">,</span><span class="s1">'gateway'</span>
<span class="n">include</span> <span class="s1">'provider:api'</span><span class="o">,</span><span class="s1">'provider:service'</span>
<span class="n">include</span> <span class="s1">'consumer:api'</span><span class="o">,</span><span class="s1">'consumer:service'</span>
</pre></div>
<p>根模块代号<code>sc-cloud</code>，包含<code>registry</code>，<code>gateway</code>和<code>provider</code>、<code>consumer</code>模块下的<code>api</code>和<code>service</code>模块。由于Gradle在处理<code>incdlude &lsquo;provider:api&lsquo;</code>时也会把<code>provider</code>包含进去，因此我们在build.gradle中进行全局性配置时需要排除这些只起分类作用的模块。</p>
<h2>根模块的build.gradle</h2>
<div class="highlight"><pre><span></span><span class="c1">//依赖版本号</span>
<span class="n">ext</span><span class="o">.</span><span class="na">versions</span> <span class="o">=</span> <span class="o">[</span>
        <span class="nl">spring:</span> <span class="s1">'4.3.17.RELEASE'</span><span class="o">,</span>
        <span class="n">springCloud</span> <span class="o">:</span><span class="s1">'Edgware.SR3'</span>
<span class="o">]</span>
<span class="c1">//依赖</span>
<span class="n">ext</span><span class="o">.</span><span class="na">libs</span> <span class="o">=</span> <span class="o">[</span>
        <span class="s2">"spring-cloud"</span><span class="o">:</span><span class="s2">"org.springframework.cloud:spring-cloud-dependencies:${versions.springCloud}"</span><span class="o">,</span>
        <span class="s2">"spring-web"</span><span class="o">:</span><span class="s2">"org.springframework:spring-web:${versions.spring}"</span><span class="o">,</span>
        <span class="s2">"spring-boot"</span><span class="o">:</span><span class="s2">"org.springframework.boot:spring-boot-starter"</span><span class="o">,</span>
        <span class="s2">"eureka-server"</span><span class="o">:</span><span class="s2">"org.springframework.cloud:spring-cloud-starter-netflix-eureka-server"</span><span class="o">,</span>
        <span class="s2">"eureka-client"</span><span class="o">:</span><span class="s2">"org.springframework.cloud:spring-cloud-starter-netflix-eureka-client"</span><span class="o">,</span>
        <span class="s2">"zuul"</span><span class="o">:</span><span class="s2">"org.springframework.cloud:spring-cloud-starter-netflix-zuul"</span><span class="o">,</span>
        <span class="s2">"feign"</span><span class="o">:</span><span class="s2">"org.springframework.cloud:spring-cloud-starter-feign"</span>
<span class="o">]</span>
<span class="c1">//只起分类作用的目录</span>
<span class="n">ext</span><span class="o">.</span><span class="na">excludeFolds</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"provider"</span><span class="o">,</span><span class="s2">"consumer"</span><span class="o">]</span>

<span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">ext</span> <span class="o">{</span>
        <span class="c1">//springIOVersion = '1.0.5.RELEASE'</span>
        <span class="n">springBootVersion</span> <span class="o">=</span> <span class="s1">'1.5.13.RELEASE'</span>
    <span class="o">}</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://maven.aliyun.com/nexus/content/groups/public/"</span> <span class="o">}</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span> <span class="s2">"org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}"</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="n">subprojects</span> <span class="o">{</span>
    <span class="c1">//对分类目录不需要进行配置</span>
    <span class="k">if</span><span class="o">(</span><span class="n">excludeFolds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="k">return</span>


    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://maven.aliyun.com/nexus/content/groups/public/"</span> <span class="o">}</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'java'</span>

    <span class="n">apply</span> <span class="nl">plugin:</span> <span class="s2">"io.spring.dependency-management"</span>

    <span class="n">dependencyManagement</span> <span class="o">{</span>
        <span class="n">imports</span> <span class="o">{</span>
            <span class="n">mavenBom</span> <span class="n">libs</span><span class="o">.</span><span class="s1">'spring-cloud'</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//api工程不需要使用spring boot插件</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s2">"api"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'org.springframework.boot'</span>
    <span class="o">}</span>

    <span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="s1">'1.8'</span>
    <span class="n">targetCompatibility</span> <span class="o">=</span> <span class="s1">'1.8'</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s1">'org.github.jamsa.sc'</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">'0.0.1'</span>

    <span class="k">if</span><span class="o">(</span><span class="n">name</span><span class="o">==</span><span class="s1">'api'</span><span class="o">){</span>
        <span class="c1">// API类工程的基本依赖</span>
        <span class="n">dependencies</span> <span class="o">{</span>
            <span class="n">compile</span> <span class="n">libs</span><span class="o">.</span><span class="s1">'spring-web'</span>
        <span class="o">}</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        <span class="c1">// Feign客户端工程的基本依赖</span>
        <span class="n">dependencies</span> <span class="o">{</span>
            <span class="n">compile</span> <span class="n">libs</span><span class="o">.</span><span class="s1">'feign'</span>
            <span class="n">compile</span> <span class="n">libs</span><span class="o">.</span><span class="s1">'eureka-client'</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//设置打包参数</span>
    <span class="n">tasks</span><span class="o">.</span><span class="na">withType</span><span class="o">(</span><span class="n">Jar</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//包名为 sc-项目名-模块名，如果父项目为根项目，则不添加&ldquo;项目名&rdquo;</span>
        <span class="n">archivesBaseName</span> <span class="o">=</span> <span class="s2">"sc-"</span><span class="o">+(</span><span class="n">project</span><span class="o">.</span><span class="na">parent</span><span class="o">==</span><span class="n">rootProject</span><span class="o">?</span><span class="n">project</span><span class="o">.</span><span class="na">name</span><span class="o">:</span><span class="n">project</span><span class="o">.</span><span class="na">parent</span><span class="o">.</span><span class="na">name</span><span class="o">+</span><span class="s2">"-"</span><span class="o">+</span><span class="n">project</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
        <span class="n">baseName</span> <span class="o">=</span> <span class="n">archivesBaseName</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>需要排除的分类目录，在<code>ext.excludeFolds</code>中维护，<code>subprojects</code>根据这个配置项进行排除。<code>subprojects</code>段中集中处理各模块的公共依赖和Gradle插件，如<code>api</code>模块都不需要依赖<code>spring boot</code>插件，但是需要<code>spring-web</code>；自动处理打包参数，设置打包名称。</p>
<p>这样处理后<code>api</code>类的子模块如果没有其它依赖，就不再需要添加<code>build.gradle</code>。<code>service</code>类的包，则只需要声明依赖和为<code>jar</code>任务指定<code>Main-Class</code>。</p>
<p>需要注意的是<code>io.spring.dependency-management</code>，这个依赖管理插件。由于SpringCloud组件较多依赖关系复杂，使用该插件才能正确的配置好版本间的依赖关系，该插件能自动根据<code>springCloud</code>版本号自动选择下面那些相依赖的组件的版本。而上面指定的spring版本也是根据依赖查询到的版本号。</p>
<p><code>buildscript</code>中的内容主要处理gradle <code>spring boot</code>插件，该插件主要用于打包FatJar。因此，在API工程中不需要启用这一插件。</p>
<h2><code>provider:service</code>的build.gradle</h2>
<div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="s1">':provider:api'</span><span class="o">)</span>
    <span class="n">compile</span> <span class="n">libs</span><span class="o">.</span><span class="s1">'eureka-client'</span>
<span class="o">}</span>

<span class="n">jar</span> <span class="o">{</span>
    <span class="n">manifest</span> <span class="o">{</span>
        <span class="n">attributes</span> <span class="s2">"Manifest-Version"</span><span class="o">:</span> <span class="mf">1.0</span><span class="o">,</span>
                <span class="s1">'Main-Class'</span><span class="o">:</span> <span class="s1">'com.github.jamsa.sc.provider.controller.ProviderController'</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>它声明了依赖于<code>:provider:api</code>并设定了<code>Main-Class</code>。</p>

      </div><!-- /.entry-content -->
      <div class="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "spring-cloud-shang-shou-1-zhun-bei.html";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//jamsa-github-io.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

    </article>
  </section>
</div>
                </div>
            </div>
        </div>

        <footer id="site-footer">
            <div class="row-fluid">
                <div class="span10 offset1">
                    <address>
                        <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                        </p>
                        <p>
                            <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                        </p>
                    </address>
                </div>
            </div>
        </footer>

<script type="text/javascript">
    var disqus_shortname = 'jamsa-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

        <link href="http://apps.bdimg.com/libs/highlight.js/9.1.0/styles/default.min.css" rel="stylesheet">
        <script src="http://apps.bdimg.com/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
         var _hmt = _hmt || [];
         (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?5e20e9cdd1185d24ece1dae11118a04f";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
         })();
        </script>
</body>
</html>