<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="author" content="Jamsa" />
        <meta name="robots" content="index, follow"/>

        <meta property="og:title" content="JTV开发笔记4-客户端"/>
        <meta property="og:url" content="./jtvkai-fa-bi-ji-4-ke-hu-duan.html"/>
        <meta property="og:site_name" content="Jamsa的笔记"/>
        <meta property="og:type" content="article"/>

        <link rel="canonical" href="./jtvkai-fa-bi-ji-4-ke-hu-duan.html" />

        <title>JTV开发笔记4-客户端 | Jamsa的笔记</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />
        

        <link rel="stylesheet" type="text/css" href="./theme/css/main.css" />

        <script type="text/javascript">var switchTo5x=true;</script>
        <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
        <script type="text/javascript">
         stLight.options({
             publisher: "",
             doNotHash: false,
             doNotCopy: false,
             hashAddressBar: false
         });
        </script>
    </head>

    <body id="index">
        <div class="row-fluid">
            <div class="span10 offset1">
                <header id="banner" >
                    <h1>
                        <a href="./">Jamsa的笔记 </a>
                    </h1>
                    <nav class="navbar">
                        <div class="navbar-inner">
                            <ul class="nav">
                                <li ><a href="./category/da-shu-ju.html">大数据</a></li>
                                <li ><a href="./category/fang-fa.html">方法</a></li>
                                <li ><a href="./category/ji-qi-xue-xi.html">机器学习</a></li>
                                <li class="active"><a href="./category/kai-fa.html">开发</a></li>
                                <li ><a href="./category/qian-duan.html">前端</a></li>
                                <li ><a href="./category/xiao-lu.html">效率</a></li>
                                <li ><a href="./category/yi-dong.html">移动</a></li>
                            </ul>

                        </div>
                    </nav>
                </header><!-- /#banner -->
            </div>
        </div>

        <div class="row-fluid">
            <div class="span10 offset1">
                <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./jtvkai-fa-bi-ji-4-ke-hu-duan.html" rel="bookmark"
             title="Permalink to JTV开发笔记4-客户端">JTV开发笔记4-客户端</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="./author/jamsa.html">Jamsa</a>
    </address>

    in <a href="./category/kai-fa.html">开发</a>

    on 2018-07-19

        |
        tags:         <a href="./tag/scala.html">scala</a>
        <a href="./tag/netty.html">netty</a>
        <a href="./tag/jtv.html">jtv</a>


        |
        <a href="./jtvkai-fa-bi-ji-4-ke-hu-duan.html#disqus_thread">comments</a>

    
</footer><!-- /.post-info -->

        <p>本文是<a href="https://github.com/Jamsa/jtv">Jtv</a>的开发笔记。Jtv是一个远程桌面工具。</p>
<h1>概述</h1>
<p>当前的客户端程序已经经过一轮重构。这轮重构将会话管理和控制窗口进行了分离。会话管理与主窗口关联。远程控制窗口使用自己的管理类，由这个类管理本窗口相关的连接，这样也方便后续增加同时控制多台远程机器的功能。</p>
<h1>设计</h1>
<h2>功能设计</h2>
<p>客户端程序主要处理这些任务：</p>
<ol>
<li>
<p>客户端连接管理：由<code>ConnectionFactory</code>管理连接的创建和销毁。</p>
</li>
<li>
<p>主窗口及会话管理：程序主窗口<code>MainFrame</code>，这个窗口的模型类<code>MainFrameManager</code>管理会话连接，处理登录、注销等与服务端交互的命令。</p>
</li>
<li>
<p>充当被控服务：当接收到远程控制请求时，<code>MainFrameManager</code>负责建立被控连接。被控连接建立后，启动屏幕捕捉线程。该线程按一定的频率，获取屏幕截图，并将它发送至被控连接。<code>MainFrameManager</code>的被控接收到鼠标键盘事件后，也负责处理事件的回放。由<code>MainFrameManager</code>来充当被控端，主要是考虑将来在服务端可以在被控端和控制端建立一对多的连接关系，被控方只需要发送一份屏幕截图，多个控制端都可以收到。</p>
</li>
<li>
<p>远程控制：当客户端作为控制端时，通过创建新的控制窗口<code>RemoteFrame</code>来实现对远程桌面的监控和操作。<code>RemoteFrame</code>打开时，使用<code>ConnectionFactory</code>建立与服务器的新连接，用该连接发送控制请求。服务端接收到这个控制请求后，从中获取被控端会话<code>ID</code>。根据这个会话<code>ID</code>查找到目标客户端（被控端）的会话通道，将控制请求发送至被控端。被控端接受到这个连接请求后，创建被控连接，并发送接受控制的响应。服务端接收到响应后，将这个连接与控制端的连接进行绑定，建立控制端与被控端的点对点连接。之后两者间就可以通过这个连接对，进行屏幕和事件发送。</p>
</li>
</ol>
<p><img alt="连接建立过程" src="./jtv/control_conn_seq.png"/> </p>
<h1>实现</h1>
<h2>网络通讯</h2>
<h3 id="lian-jie-guan-li">连接管理</h3>
<p>对连接的管理与之前服务端的方式有些类似，在<code>ConnectionFactory</code>中创建连接，在创建连接时注册<code>closeFuture</code>回调，在回调中对连接相关的集合进行清理。</p>
<div class="highlight"><pre><span></span>  <span class="k">private</span> <span class="k">def</span> <span class="n">createConnection</span><span class="o">()={</span>
    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Network</span><span class="o">.</span><span class="n">createChannel</span>

    <span class="n">result</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span> <span class="n">ch</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"新建连接:</span><span class="si">${</span><span class="n">ch</span><span class="o">.</span><span class="n">id</span><span class="o">().</span><span class="n">asLongText</span><span class="o">()</span><span class="si">}</span><span class="s">，设置会话ID为：</span><span class="si">${</span><span class="n">sessionId</span><span class="si">}</span><span class="s">"</span><span class="o">)</span>
      <span class="n">sessionId</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="nc">ChannelUtils</span><span class="o">.</span><span class="n">setSessionId</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span><span class="k">_</span><span class="o">))</span>
      <span class="n">workChannels</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="n">id</span><span class="o">().</span><span class="n">asLongText</span><span class="o">(),</span><span class="n">ch</span><span class="o">)</span>
      <span class="n">ch</span><span class="o">.</span><span class="n">closeFuture</span><span class="o">().</span><span class="n">addListener</span><span class="o">((</span><span class="n">future</span><span class="k">:</span><span class="kt">ChannelFuture</span><span class="o">)</span> <span class="o">=&gt;{</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"工作连接</span><span class="si">${</span><span class="n">future</span><span class="o">.</span><span class="n">channel</span><span class="o">().</span><span class="n">id</span><span class="o">().</span><span class="n">asLongText</span><span class="o">()</span><span class="si">}</span><span class="s">被关闭"</span><span class="o">)</span>
        <span class="n">workChannels</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="n">channel</span><span class="o">().</span><span class="n">id</span><span class="o">().</span><span class="n">asLongText</span><span class="o">())</span>
      <span class="o">})</span>
    <span class="o">})</span>
    <span class="n">result</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">createConnection</span><span class="o">(</span><span class="n">callback</span><span class="k">:</span><span class="kt">ConnectionCallback</span><span class="o">)</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]={</span>
    <span class="n">createConnection</span><span class="o">().</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">Connection</span><span class="o">(</span><span class="k">_</span><span class="o">,</span><span class="n">callback</span><span class="o">))</span>
  <span class="o">}</span>
</pre></div>
<h3 id="xiao-xi-hui-diao-chu-li">消息回调处理</h3>
<p>上面代码中，不带参数的<code>createConnection</code>是私有方法，它负责建立连接。带参数的方法需要传递<code>ConnectionCallback</code>，这个对象作为连接的消息处理回调，方法返回的是<code>Option[Connection]</code>对象。这样能实现在不同的连接上注册不同的消息监听，执行特定的逻辑处理。如何实现在通道上接收到消息时，调用特定的回调呢？我是通过<code>Channel</code>的<code>attr</code>实现的。在<code>Connection</code>的构造器上将<code>Connection</code>对象绑定至它持有的<code>Channel</code>，当<code>Handler</code>接收到消息时，从<code>Channel</code>上获取<code>Connection</code>对象，并调用<code>Connection</code>上的消息回调函数即可。实现了不同类型的连接处理逻辑的分离。</p>
<p><code>Connection</code>类：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Connection</span><span class="o">(</span><span class="k">val</span> <span class="n">channel</span><span class="k">:</span><span class="kt">Channel</span><span class="o">,</span><span class="k">val</span> <span class="n">callback</span><span class="k">:</span><span class="kt">ConnectionCallback</span><span class="o">){</span><span class="n">conn</span><span class="k">=&gt;</span>
  <span class="n">channel</span><span class="o">.</span><span class="n">closeFuture</span><span class="o">().</span><span class="n">addListener</span><span class="o">((</span><span class="n">future</span><span class="k">:</span><span class="kt">ChannelFuture</span><span class="o">)</span> <span class="o">=&gt;{</span>
    <span class="n">callback</span><span class="o">.</span><span class="n">onClose</span><span class="o">(</span><span class="n">future</span><span class="o">)</span>
  <span class="o">})</span>

  <span class="nc">ChannelUtils</span><span class="o">.</span><span class="n">setConnection</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span><span class="k">this</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">sendMessage</span><span class="o">(</span><span class="n">message</span><span class="k">:</span><span class="kt">JtvMessage</span><span class="o">)={</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">close</span><span class="o">()</span><span class="k">:</span> <span class="kt">ChannelFuture</span> <span class="o">={</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><code>ChannelUtils.setConnection</code>将<code>Connection</code>绑定至<code>Channel</code>的<code>attr</code>上。</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">setConnection</span><span class="o">(</span><span class="n">channel</span><span class="k">:</span><span class="kt">Channel</span><span class="o">,</span><span class="n">conn</span><span class="k">:</span><span class="kt">Connection</span><span class="o">)={</span>
  <span class="n">channel</span><span class="o">.</span><span class="n">attr</span><span class="o">(</span><span class="nc">CONNECTION_KEY</span><span class="o">).</span><span class="n">set</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
<p>当<code>Handler</code>接收到消息时，只需要获取<code>Channel</code>上绑定的<code>Connection</code>对象的回调方法。</p>
<div class="highlight"><pre><span></span>  <span class="k">override</span> <span class="k">def</span> <span class="n">channelRead0</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">JtvMessage</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"接收到消息:</span><span class="si">${</span><span class="n">msg</span><span class="si">}</span><span class="s">"</span><span class="o">)</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">m</span><span class="k">:</span><span class="kt">ClientSessionMessage</span> <span class="o">=&gt;</span> <span class="nc">ChannelUtils</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">()).</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">onMessage</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span><span class="n">m</span><span class="o">))</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"无法识别的消息，关闭连接</span><span class="si">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">().</span><span class="n">id</span><span class="o">().</span><span class="n">asLongText</span><span class="o">()</span><span class="si">}</span><span class="s">"</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
<h2>远程控制</h2>
<p>远程控制的主要过程是：</p>
<ol>
<li>
<p>被控端通过Java <code>Robot</code>类获取屏幕画面，并发关至控制端。</p>
</li>
<li>
<p>控制端在远程控制窗口中，展示该画面。</p>
</li>
<li>
<p>控制端在远程控制窗口中进行的鼠标和键盘操作将被记录，并发送至被控端。</p>
</li>
<li>
<p>被控端获取到鼠标键盘消息后，通过<code>Robot</code>类回放这些事件。</p>
</li>
</ol>
<h3 id="bei-kong-duan">被控端</h3>
<h4 id="ping-mu-tu-xiang-bu-huo">屏幕图像捕获</h4>
<p>屏幕捕获使用单独的线程，按每秒12帧的速度（影片24帧/秒，我取一半），即83ms一帧进行捕获。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ScreenCapture</span> <span class="k">extends</span> <span class="nc">Thread</span><span class="o">{</span>

  <span class="k">val</span> <span class="n">tk</span> <span class="k">=</span> <span class="nc">Toolkit</span><span class="o">.</span><span class="n">getDefaultToolkit</span>
  <span class="k">val</span> <span class="n">dm</span> <span class="k">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">getScreenSize</span>
  <span class="k">val</span> <span class="n">robot</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Robot</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">rec</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Rectangle</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">dm</span><span class="o">.</span><span class="n">width</span><span class="o">,</span><span class="n">dm</span><span class="o">.</span><span class="n">height</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">interval</span> <span class="k">=</span> <span class="mi">83</span>

  <span class="cm">/*</span>
<span class="cm">  type CaptureCallback = BufferedImage =&gt; Unit</span>
<span class="cm">  var callback:Option[CaptureCallback] = None</span>
<span class="cm">  def startCapture(cb:Option[CaptureCallback]): Unit ={</span>
<span class="cm">    callback = cb</span>
<span class="cm">    start()</span>
<span class="cm">  }*/</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="n">interrupted</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">startMillis</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span>
        <span class="k">val</span> <span class="n">bufferedImage</span> <span class="k">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">createScreenCapture</span><span class="o">(</span><span class="n">rec</span><span class="o">)</span>
        <span class="nc">MainFrameManager</span><span class="o">.</span><span class="n">setScreenCapture</span><span class="o">(</span><span class="n">bufferedImage</span><span class="o">)</span>
        <span class="cm">/*callback match {</span>
<span class="cm">          case Some(cb) =&gt; cb(bufferedImage)</span>
<span class="cm">          case _ =&gt; None</span>
<span class="cm">        }*/</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()-</span><span class="n">startMillis</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">{</span>
      <span class="k">case</span> <span class="k">_:</span><span class="kt">InterruptedException</span> <span class="o">=&gt;</span> <span class="nc">Thread</span><span class="o">.</span><span class="n">currentThread</span><span class="o">().</span><span class="n">interrupt</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>



  <span class="k">def</span> <span class="n">startCapture</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">={</span>
    <span class="n">start</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">stopCapture</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">={</span>
    <span class="c1">//callback = None</span>
    <span class="n">interrupt</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>取得的图像会被<code>MainFrameManager</code>通过被控连接，发送至控制端。</p>
<h4 id="shi-jian-hui-fang">事件回放</h4>
<p>当被控连接上接收到鼠标键盘事件时，由<code>Robot</code>类进行事件回放。</p>
<div class="highlight"><pre><span></span>  <span class="k">private</span> <span class="k">val</span> <span class="n">tk</span> <span class="k">=</span> <span class="nc">Toolkit</span><span class="o">.</span><span class="n">getDefaultToolkit</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">dm</span> <span class="k">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">getScreenSize</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">robot</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Robot</span><span class="o">()</span>
  <span class="k">def</span> <span class="n">receiveMouseEvent</span><span class="o">(</span><span class="n">mouseEventMessage</span><span class="k">:</span> <span class="kt">MouseEventMessage</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">={</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"接收鼠标事件</span><span class="si">${</span><span class="n">mouseEventMessage</span><span class="si">}</span><span class="s">"</span><span class="o">)</span>

    <span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">id</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_PRESSED</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">button</span> <span class="k">=</span> <span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">button</span>

        <span class="n">button</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON1</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mousePress</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON1_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON2</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mousePress</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON2_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON3</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mousePress</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON3_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_RELEASED</span> <span class="o">|</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_CLICKED</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">button</span> <span class="k">=</span> <span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">button</span>

        <span class="n">button</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON1</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mouseRelease</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON1_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON2</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mouseRelease</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON2_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">BUTTON3</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">mouseRelease</span><span class="o">(</span><span class="nc">InputEvent</span><span class="o">.</span><span class="nc">BUTTON3_MASK</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_WHEEL</span> <span class="k">=&gt;</span><span class="n">robot</span><span class="o">.</span><span class="n">mouseWheel</span><span class="o">(</span><span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">wheelRotation</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_MOVED</span> <span class="o">|</span> <span class="nc">MouseEvent</span><span class="o">.</span><span class="nc">MOUSE_DRAGGED</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">dm</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">screenWidth</span>
        <span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">dm</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">screenHeight</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">mouseMove</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"(</span><span class="si">${</span><span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s">,</span><span class="si">${</span><span class="n">mouseEventMessage</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s">)映射为(</span><span class="si">${</span><span class="n">x</span><span class="si">}</span><span class="s">,</span><span class="si">${</span><span class="n">y</span><span class="si">}</span><span class="s">)"</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">receiveKeyEvent</span><span class="o">(</span><span class="n">keyEventMessage</span><span class="k">:</span> <span class="kt">KeyEventMessage</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">={</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s"接收键盘事件</span><span class="si">${</span><span class="n">keyEventMessage</span><span class="si">}</span><span class="s">"</span><span class="o">)</span>
    <span class="n">keyEventMessage</span><span class="o">.</span><span class="n">id</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">KeyEvent</span><span class="o">.</span><span class="nc">KEY_PRESSED</span> <span class="o">=&gt;{</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">keyPress</span><span class="o">(</span><span class="n">keyEventMessage</span><span class="o">.</span><span class="n">keyCode</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nc">KeyEvent</span><span class="o">.</span><span class="nc">KEY_RELEASED</span><span class="o">=&gt;{</span>
        <span class="n">robot</span><span class="o">.</span><span class="n">keyRelease</span><span class="o">(</span><span class="n">keyEventMessage</span><span class="o">.</span><span class="n">keyCode</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
<p>在<code>logger.info</code>的这行上面，我们对鼠标移动事件的坐标进行了转换。这是因为传递过来的消息中的坐标是控制端在控制窗口中的坐标，我们需要将它映射至被控端的屏幕坐标。<code>dm.width</code>和<code>dm.height</code>分别是控制窗口的宽度和高度。</p>
<h3 id="kong-zhi-duan_1">控制端</h3>
<h4 id="ping-mu-tu-xiang-hui-fang">屏幕图像回放</h4>
<p>控制端我使用了自定义的<code>Panel</code>来绘制远程传来的屏幕图像。</p>
<div class="highlight"><pre><span></span><span class="n">lass</span> <span class="nc">RemoteDesktopPanel</span> <span class="k">extends</span> <span class="nc">JPanel</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">image</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">BufferedImage</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
    <span class="k">private</span> <span class="k">var</span> <span class="n">changed</span> <span class="k">=</span> <span class="kc">true</span>

  <span class="n">setBackground</span><span class="o">(</span><span class="nc">Color</span><span class="o">.</span><span class="nc">GRAY</span><span class="o">)</span>
  <span class="k">this</span><span class="o">.</span><span class="n">setFocusable</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">setImage</span><span class="o">(</span><span class="n">image</span><span class="k">:</span> <span class="kt">BufferedImage</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span> <span class="c1">//this.image = image;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">image</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">image</span><span class="o">)</span>
    <span class="k">this</span><span class="o">.</span><span class="n">changed</span><span class="k">=</span><span class="kc">true</span>
    <span class="k">this</span><span class="o">.</span><span class="n">repaint</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">getPreferredSize</span><span class="k">:</span> <span class="kt">Dimension</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">super</span><span class="o">.</span><span class="n">getPreferredSize</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">paintComponent</span><span class="o">(</span><span class="n">g</span><span class="k">:</span> <span class="kt">Graphics</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">super</span><span class="o">.</span><span class="n">paintComponent</span><span class="o">(</span><span class="n">g</span><span class="o">)</span>
    <span class="k">if</span><span class="o">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">.</span><span class="n">isDefined</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">g2d</span> <span class="k">=</span> <span class="n">g</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Graphics2D</span><span class="o">]</span>
      <span class="n">g2d</span><span class="o">.</span><span class="n">drawImage</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">getWidth</span><span class="o">,</span><span class="n">getHeight</span><span class="o">,</span><span class="k">this</span><span class="o">)</span>
      <span class="n">changed</span><span class="k">=</span><span class="kc">false</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>控制端接收到屏幕图像后，会调用上面的<code>setImage</code>方法，这个方法会触发<code>Panel</code>的重绘，调用<code>paintComponent</code>方法，将图像绘制出来。默认情况下<code>Panel</code>是不能接收鼠标和键盘事件的，需要设置<code>Panel</code>的<code>setFocusable(true)</code>，</p>
<h4 id="shi-jian-bu-zhuo">事件捕捉</h4>
<p>在显示远程桌面的<code>RemoteDesktopPanel</code>上添加鼠标和键盘事件监听。监听到事件后，通过控制连接将事件发送至被控端。</p>
<div class="highlight"><pre><span></span>      <span class="k">val</span> <span class="n">mouseAdapter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MouseAdapter</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseClicked</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mousePressed</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseReleased</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseEntered</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseExited</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseWheelMoved</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseWheelEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseDragged</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">mouseMoved</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">MouseEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">canvasPanel</span><span class="o">.</span><span class="n">addMouseListener</span><span class="o">(</span><span class="n">mouseAdapter</span><span class="o">)</span>
    <span class="n">canvasPanel</span><span class="o">.</span><span class="n">addMouseMotionListener</span><span class="o">(</span><span class="n">mouseAdapter</span><span class="o">)</span>
    <span class="n">canvasPanel</span><span class="o">.</span><span class="n">addMouseWheelListener</span><span class="o">(</span><span class="n">mouseAdapter</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">keyAdapter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">KeyAdapter</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">keyTyped</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">KeyEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">keyPressed</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">KeyEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">override</span> <span class="k">def</span> <span class="n">keyReleased</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">KeyEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">sendEvent</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getWidth</span><span class="o">,</span><span class="n">canvasPanel</span><span class="o">.</span><span class="n">getHeight</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">canvasPanel</span><span class="o">.</span><span class="n">addKeyListener</span><span class="o">(</span><span class="n">keyAdapter</span><span class="o">)</span>
</pre></div>
<p>这里的<code>canvasPanel</code>就是一个<code>RemoteDesktopPanel</code>对象。</p>

      </div><!-- /.entry-content -->
      <div class="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "jtvkai-fa-bi-ji-4-ke-hu-duan.html";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//jamsa-github-io.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

    </article>
  </section>
</div>
                </div>
            </div>
        </div>

        <footer id="site-footer">
            <div class="row-fluid">
                <div class="span10 offset1">
                    <address>
                        <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                        </p>
                        <p>
                            <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                        </p>
                    </address>
                </div>
            </div>
        </footer>

<script type="text/javascript">
    var disqus_shortname = 'jamsa-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

        <link href="http://apps.bdimg.com/libs/highlight.js/9.1.0/styles/default.min.css" rel="stylesheet">
        <script src="http://apps.bdimg.com/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
         var _hmt = _hmt || [];
         (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?5e20e9cdd1185d24ece1dae11118a04f";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
         })();
        </script>
</body>
</html>